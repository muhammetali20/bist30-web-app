<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BIST30 Alım-Satım Bot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            transition: transform 0.3s;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .card-header {
            font-weight: bold;
            background-color: #f1f5f9;
        }
        .btn-primary {
            background-color: #0d6efd;
            border: none;
        }
        .btn-success {
            background-color: #198754;
            border: none;
        }
        .btn-danger {
            background-color: #dc3545;
            border: none;
        }
        .btn-warning {
            background-color: #ffc107;
            border: none;
            color: #000;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .signal-badge {
            font-size: 0.8rem;
            padding: 5px 10px;
            border-radius: 20px;
        }
        .table-responsive {
            border-radius: 10px;
            overflow: hidden;
        }
        .table {
            margin-bottom: 0;
        }
        .table th {
            background-color: #f1f5f9;
        }
        #statusMessages {
            max-height: 200px;
            overflow-y: auto;
        }
        .status-message {
            padding: 5px 10px;
            margin-bottom: 5px;
            border-radius: 5px;
        }
        .status-success {
            background-color: #d1e7dd;
            color: #0f5132;
        }
        .status-error {
            background-color: #f8d7da;
            color: #842029;
        }
        .status-info {
            background-color: #cff4fc;
            color: #055160;
        }
        .chart-container {
            height: 300px;
            width: 100%;
        }
        .report-card .card-body {
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-graph-up-arrow"></i> BIST30 Alım-Satım Bot
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#dashboard">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#reports">Raporlar</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#signals">Sinyaller</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#analysis">Analiz</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#settings">Ayarlar</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
        <!-- Status Alert -->
        <div id="statusAlert" class="alert alert-info mb-4" role="alert" style="display: none;">
            <i class="bi bi-info-circle-fill me-2"></i>
            <span id="statusText">İşlem durumu burada görüntülenecek.</span>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard" class="mb-5">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Dashboard</h2>
                <button id="runWeeklyAnalysisBtn" class="btn btn-primary">
                    <i class="bi bi-play-fill"></i> Haftalık Analiz Çalıştır
                </button>
            </div>

            <div class="row">
                <!-- Quick Stats -->
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-bar-chart-fill me-2"></i> Özet İstatistikler
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-3">
                                <span>Toplam Hisse:</span>
                                <span id="totalSymbols">-</span>
                            </div>
                            <div class="d-flex justify-content-between mb-3">
                                <span>Alım Sinyali:</span>
                                <span id="buySignalCount" class="badge bg-success">0</span>
                            </div>
                            <div class="d-flex justify-content-between mb-3">
                                <span>Satım Sinyali:</span>
                                <span id="sellSignalCount" class="badge bg-danger">0</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Son Güncelleme:</span>
                                <span id="lastUpdate">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Status Messages -->
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-terminal-fill me-2"></i> İşlem Durumu
                        </div>
                        <div class="card-body">
                            <div id="statusMessages">
                                <div class="status-message status-info">
                                    Sistem hazır. Haftalık analiz çalıştırabilirsiniz.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Latest Signals -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-arrow-up-circle-fill me-2 text-success"></i> Son Alım Sinyalleri
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Sembol</th>
                                            <th>Fiyat</th>
                                            <th>Tarih</th>
                                            <th>Neden</th>
                                        </tr>
                                    </thead>
                                    <tbody id="buySignalsTable">
                                        <tr>
                                            <td colspan="4" class="text-center">Henüz sinyal yok</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-arrow-down-circle-fill me-2 text-danger"></i> Son Satım Sinyalleri
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Sembol</th>
                                            <th>Fiyat</th>
                                            <th>Tarih</th>
                                            <th>Neden</th>
                                        </tr>
                                    </thead>
                                    <tbody id="sellSignalsTable">
                                        <tr>
                                            <td colspan="4" class="text-center">Henüz sinyal yok</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports Section -->
        <div id="reports" class="mb-5" style="display: none;">
            <h2 class="mb-4">Raporlar</h2>
            
            <div class="row mb-4">
                <div class="col-md-4">
                    <button id="generateDailyNoonReportBtn" class="btn btn-warning w-100">
                        <i class="bi bi-sun-fill me-2"></i> Günlük Öğlen Raporu
                    </button>
                </div>
                <div class="col-md-4">
                    <button id="generateDailyCloseReportBtn" class="btn btn-secondary w-100">
                        <i class="bi bi-moon-fill me-2"></i> Günlük Kapanış Raporu
                    </button>
                </div>
                <div class="col-md-4">
                    <button id="generateWeeklyReportBtn" class="btn btn-info w-100">
                        <i class="bi bi-calendar-week-fill me-2"></i> Haftalık Rapor
                    </button>
                </div>
            </div>
            <div class="row mb-4">
                <div class="col-md-4">
                    <button id="generateNextDayPredictionBtn" class="btn btn-success w-100">
                        <i class="bi bi-arrow-right-circle-fill me-2"></i> Ertesi Gün Tahmini
                    </button>
                </div>
            </div>

            <!-- Report Display Area -->
            <div id="reportDisplayArea" class="row">
                <!-- Reports will be displayed here -->
            </div>
        </div>

        <!-- Signals Section -->
        <div id="signals" class="mb-5" style="display: none;">
            <h2 class="mb-4">Sinyaller</h2>
            
            <div class="card mb-4">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-search me-2"></i> Hisse Ara</span>
                        <button id="refreshSymbolsBtn" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-arrow-clockwise"></i> Yenile
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <select id="symbolSelect" class="form-select mb-3">
                                <option value="">Hisse seçin...</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <button id="getSignalBtn" class="btn btn-primary">
                                <i class="bi bi-lightning-fill"></i> Sinyal Getir
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="signalResult" class="card" style="display: none;">
                <div class="card-header">
                    <i class="bi bi-info-circle-fill me-2"></i> Sinyal Sonucu
                </div>
                <div class="card-body">
                    <div id="signalDetails">
                        <!-- Signal details will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Analysis Section -->
        <div id="analysis" class="mb-5" style="display: none;">
            <h2 class="mb-4">Teknik Analiz</h2>
            
            <div class="card mb-4">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-graph-up me-2"></i> Hisse Analizi</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <select id="analysisSymbolSelect" class="form-select">
                                <option value="">Hisse seçin...</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <button id="getAnalysisBtn" class="btn btn-primary">
                                <i class="bi bi-graph-up-arrow"></i> Analiz Et
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="analysisResult" style="display: none;">
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="bi bi-bar-chart-line-fill me-2"></i> Fiyat Grafiği
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="priceChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <i class="bi bi-graph-up-arrow me-2"></i> Teknik Göstergeler
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Tarih</th>
                                        <th>Kapanış</th>
                                        <th>MA (5)</th>
                                        <th>MA (20)</th>
                                        <th>RSI</th>
                                        <th>MACD</th>
                                        <th>Signal</th>
                                    </tr>
                                </thead>
                                <tbody id="technicalIndicatorsTable">
                                    <!-- Technical indicators will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Section -->
        <div id="settings" class="mb-5" style="display: none;">
            <h2 class="mb-4">Ayarlar</h2>
            
            <!-- Telegram Settings Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-telegram me-2"></i> Telegram Bot Ayarları
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="alert alert-info">
                                <h6><i class="bi bi-info-circle me-2"></i> Telegram Bot Kurulumu</h6>
                                <p class="mb-2">Telegram bildirimleri almak için bot kurulumu gereklidir:</p>
                                <ol class="mb-0">
                                    <li><strong>@BotFather</strong> ile yeni bot oluşturun</li>
                                    <li>Bot token ve Chat ID'nizi alın</li>
                                    <li>Render.com'da Environment Variables ekleyin</li>
                                    <li>Test butonuyla bağlantıyı test edin</li>
                                </ol>
                                <small class="text-muted">Detaylı talimatlar için <strong>TELEGRAM_SETUP.md</strong> dosyasına bakın.</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <button id="testTelegramBtn" class="btn btn-success w-100">
                                <i class="bi bi-telegram me-2"></i> Telegram Test Et
                            </button>
                            <small class="text-muted d-block mt-2">
                                Bot token ayarlandıysa test mesajı gönderir
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- System Settings Card -->
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-gear-fill me-2"></i> Sistem Ayarları
                </div>
                <div class="card-body">
                    <form id="settingsForm">
                        <div class="mb-3">
                            <label for="targetProfitInput" class="form-label">Hedef Kâr Yüzdesi (%)</label>
                            <input type="number" class="form-control" id="targetProfitInput" value="5" min="1" max="20" step="0.5">
                        </div>
                        <div class="mb-3">
                            <label for="stopLossInput" class="form-label">Stop-Loss Yüzdesi (%)</label>
                            <input type="number" class="form-control" id="stopLossInput" value="3" min="1" max="10" step="0.5">
                        </div>
                        <div class="mb-3">
                            <label for="maxHoldingWeeksInput" class="form-label">Maksimum Bekleme Süresi (Hafta)</label>
                            <input type="number" class="form-control" id="maxHoldingWeeksInput" value="4" min="1" max="12">
                        </div>
                        <button type="submit" class="btn btn-primary">Kaydet</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-light py-4 mt-5">
        <div class="container text-center">
            <p class="mb-0">© 2025 BIST30 Alım-Satım Bot | Tüm hakları saklıdır.</p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Navigation
            const navLinks = document.querySelectorAll('.navbar-nav .nav-link');
            const sections = document.querySelectorAll('#dashboard, #reports, #signals, #analysis, #settings');
            
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Update active link
                    navLinks.forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Show corresponding section
                    const targetId = this.getAttribute('href').substring(1);
                    sections.forEach(section => {
                        section.style.display = section.id === targetId ? 'block' : 'none';
                    });
                });
            });

            // Status functions
            function showStatus(message, type = 'info') {
                const statusAlert = document.getElementById('statusAlert');
                const statusText = document.getElementById('statusText');
                
                statusText.textContent = message;
                
                // Set alert type
                statusAlert.className = 'alert mb-4';
                statusAlert.classList.add(`alert-${type}`);
                
                // Show alert
                statusAlert.style.display = 'block';
                
                // Auto hide after 5 seconds for success messages
                if (type === 'success') {
                    setTimeout(() => {
                        statusAlert.style.display = 'none';
                    }, 5000);
                }
            }

            function addStatusMessage(message, type = 'info') {
                const statusMessages = document.getElementById('statusMessages');
                const messageElement = document.createElement('div');
                
                messageElement.className = 'status-message';
                messageElement.classList.add(`status-${type}`);
                messageElement.textContent = message;
                
                statusMessages.prepend(messageElement);
                
                // Limit to 10 messages
                if (statusMessages.children.length > 10) {
                    statusMessages.removeChild(statusMessages.lastChild);
                }
            }

            // Load symbols
            function loadSymbols() {
                fetch('/api/bist30/symbols')
                    .then(response => response.json())
                    .then(data => {
                        if (data.symbols) {
                            const symbolSelect = document.getElementById('symbolSelect');
                            const analysisSymbolSelect = document.getElementById('analysisSymbolSelect');
                            
                            // Clear existing options
                            symbolSelect.innerHTML = '<option value="">Hisse seçin...</option>';
                            analysisSymbolSelect.innerHTML = '<option value="">Hisse seçin...</option>';
                            
                            // Add symbols
                            data.symbols.forEach(symbol => {
                                const option = document.createElement('option');
                                option.value = symbol;
                                option.textContent = symbol;
                                
                                symbolSelect.appendChild(option.cloneNode(true));
                                analysisSymbolSelect.appendChild(option);
                            });
                            
                            // Update total symbols count
                            document.getElementById('totalSymbols').textContent = data.count;
                            
                            addStatusMessage(`${data.count} hisse sembolü yüklendi.`, 'success');
                        }
                    })
                    .catch(error => {
                        console.error('Error loading symbols:', error);
                        addStatusMessage('Semboller yüklenirken hata oluştu.', 'error');
                    });
            }

            // Run weekly analysis
            document.getElementById('runWeeklyAnalysisBtn').addEventListener('click', function() {
                this.disabled = true;
                this.innerHTML = '<span class="loading me-2"></span> Analiz Çalışıyor...';
                
                showStatus('Haftalık analiz çalışıyor...', 'info');
                addStatusMessage('Haftalık analiz başlatıldı.', 'info');
                
                fetch('/api/bist30/run-weekly-analysis', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showStatus('Haftalık analiz başarıyla tamamlandı.', 'success');
                        addStatusMessage('Haftalık analiz tamamlandı.', 'success');
                        
                        // Update stats
                        document.getElementById('buySignalCount').textContent = data.report.signals.buy_count;
                        document.getElementById('sellSignalCount').textContent = data.report.signals.sell_count;
                        document.getElementById('lastUpdate').textContent = data.report.timestamp;
                        
                        // Update signal tables
                        updateSignalTables(data.report.signals.buy_signals, data.report.signals.sell_signals);
                    } else {
                        showStatus(`Hata: ${data.message}`, 'danger');
                        addStatusMessage(`Analiz hatası: ${data.message}`, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error running analysis:', error);
                    showStatus('Analiz çalıştırılırken bir hata oluştu.', 'danger');
                    addStatusMessage('Analiz çalıştırılırken bir hata oluştu.', 'error');
                })
                .finally(() => {
                    this.disabled = false;
                    this.innerHTML = '<i class="bi bi-play-fill"></i> Haftalık Analiz Çalıştır';
                });
            });

            // Update signal tables
            function updateSignalTables(buySignals, sellSignals) {
                const buyTable = document.getElementById('buySignalsTable');
                const sellTable = document.getElementById('sellSignalsTable');
                
                // Clear tables
                buyTable.innerHTML = '';
                sellTable.innerHTML = '';
                
                // Add buy signals
                if (buySignals && buySignals.length > 0) {
                    buySignals.forEach(signal => {
                        const row = document.createElement('tr');
                        
                        row.innerHTML = `
                            <td><strong>${signal.symbol}</strong></td>
                            <td>${signal.current_price ? signal.current_price.toFixed(2) : '-'} TL</td>
                            <td>${signal.last_date}</td>
                            <td><small>${truncateText(signal.buy_reason, 50)}</small></td>
                        `;
                        
                        buyTable.appendChild(row);
                    });
                } else {
                    buyTable.innerHTML = '<tr><td colspan="4" class="text-center">Alım sinyali bulunamadı</td></tr>';
                }
                
                // Add sell signals
                if (sellSignals && sellSignals.length > 0) {
                    sellSignals.forEach(signal => {
                        const row = document.createElement('tr');
                        
                        row.innerHTML = `
                            <td><strong>${signal.symbol}</strong></td>
                            <td>${signal.current_price ? signal.current_price.toFixed(2) : '-'} TL</td>
                            <td>${signal.last_date}</td>
                            <td><small>${truncateText(signal.sell_reason, 50)}</small></td>
                        `;
                        
                        sellTable.appendChild(row);
                    });
                } else {
                    sellTable.innerHTML = '<tr><td colspan="4" class="text-center">Satım sinyali bulunamadı</td></tr>';
                }
            }

            // Helper function to truncate text
            function truncateText(text, maxLength) {
                if (!text) return '';
                return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
            }

            // Get signal for specific symbol
            document.getElementById('getSignalBtn').addEventListener('click', function() {
                const symbol = document.getElementById('symbolSelect').value;
                
                if (!symbol) {
                    showStatus('Lütfen bir hisse seçin.', 'warning');
                    return;
                }
                
                this.disabled = true;
                this.innerHTML = '<span class="loading me-2"></span> Yükleniyor...';
                
                fetch(`/api/bist30/signals/${symbol}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const signal = data.signal;
                            const signalResult = document.getElementById('signalResult');
                            const signalDetails = document.getElementById('signalDetails');
                            
                            let content = `
                                <h4>${symbol}</h4>
                                <p><strong>Güncel Fiyat:</strong> ${signal.current_price ? signal.current_price.toFixed(2) + ' TL' : 'Veri yok'}</p>
                                <p><strong>Son Tarih:</strong> ${signal.last_date || 'Veri yok'}</p>
                            `;
                            
                            if (signal.buy_signal) {
                                content += `
                                    <div class="alert alert-success">
                                        <h5><i class="bi bi-arrow-up-circle-fill me-2"></i> Alım Sinyali</h5>
                                        <p>${signal.buy_reason}</p>
                                    </div>
                                `;
                            } else {
                                content += `
                                    <div class="alert alert-secondary">
                                        <p><i class="bi bi-x-circle me-2"></i> Alım sinyali yok: ${signal.buy_reason}</p>
                                    </div>
                                `;
                            }
                            
                            if (signal.sell_signal) {
                                content += `
                                    <div class="alert alert-danger">
                                        <h5><i class="bi bi-arrow-down-circle-fill me-2"></i> Satım Sinyali</h5>
                                        <p>${signal.sell_reason}</p>
                                    </div>
                                `;
                            } else {
                                content += `
                                    <div class="alert alert-secondary">
                                        <p><i class="bi bi-x-circle me-2"></i> Satım sinyali yok: ${signal.sell_reason}</p>
                                    </div>
                                `;
                            }
                            
                            signalDetails.innerHTML = content;
                            signalResult.style.display = 'block';
                            
                            addStatusMessage(`${symbol} için sinyal bilgisi alındı.`, 'success');
                        } else {
                            showStatus(`Hata: ${data.message}`, 'danger');
                            addStatusMessage(`Sinyal hatası: ${data.message}`, 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error getting signal:', error);
                        showStatus('Sinyal alınırken bir hata oluştu.', 'danger');
                    })
                    .finally(() => {
                        this.disabled = false;
                        this.innerHTML = '<i class="bi bi-lightning-fill"></i> Sinyal Getir';
                    });
            });

            // Get technical analysis for specific symbol
            document.getElementById('getAnalysisBtn').addEventListener('click', function() {
                const symbol = document.getElementById('analysisSymbolSelect').value;
                
                if (!symbol) {
                    showStatus('Lütfen bir hisse seçin.', 'warning');
                    return;
                }
                
                this.disabled = true;
                this.innerHTML = '<span class="loading me-2"></span> Analiz Ediliyor...';
                
                fetch(`/api/bist30/technical-data/${symbol}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.data) {
                            // Show analysis result section
                            document.getElementById('analysisResult').style.display = 'block';
                            
                            // Populate technical indicators table
                            const table = document.getElementById('technicalIndicatorsTable');
                            table.innerHTML = '';
                            
                            // Sort data by date (newest first)
                            const sortedData = data.data.sort((a, b) => new Date(b.date) - new Date(a.date));
                            
                            // Take only the last 10 records
                            const recentData = sortedData.slice(0, 10);
                            
                            recentData.forEach(row => {
                                const tr = document.createElement('tr');
                                
                                tr.innerHTML = `
                                    <td>${row.date}</td>
                                    <td>${row.close ? row.close.toFixed(2) : '-'}</td>
                                    <td>${row.ma_short ? row.ma_short.toFixed(2) : '-'}</td>
                                    <td>${row.ma_long ? row.ma_long.toFixed(2) : '-'}</td>
                                    <td>${row.rsi ? row.rsi.toFixed(2) : '-'}</td>
                                    <td>${row.macd ? row.macd.toFixed(4) : '-'}</td>
                                    <td>${row.macd_signal ? row.macd_signal.toFixed(4) : '-'}</td>
                                `;
                                
                                table.appendChild(tr);
                            });
                            
                            // Create price chart
                            createPriceChart(sortedData.reverse(), symbol);
                            
                            addStatusMessage(`${symbol} için teknik analiz tamamlandı.`, 'success');
                        } else {
                            showStatus(`Hata: ${data.message || 'Veri bulunamadı'}`, 'danger');
                            addStatusMessage(`Analiz hatası: ${data.message || 'Veri bulunamadı'}`, 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error getting technical data:', error);
                        showStatus('Teknik veri alınırken bir hata oluştu.', 'danger');
                    })
                    .finally(() => {
                        this.disabled = false;
                        this.innerHTML = '<i class="bi bi-graph-up-arrow"></i> Analiz Et';
                    });
            });

            // Create price chart
            let priceChart = null;
            function createPriceChart(data, symbol) {
                const ctx = document.getElementById('priceChart').getContext('2d');
                
                // Destroy existing chart if it exists
                if (priceChart) {
                    priceChart.destroy();
                }
                
                // Prepare data
                const labels = data.map(item => item.date);
                const prices = data.map(item => item.close);
                const maShort = data.map(item => item.ma_short);
                const maLong = data.map(item => item.ma_long);
                
                // Create new chart
                priceChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Fiyat',
                                data: prices,
                                borderColor: 'rgba(75, 192, 192, 1)',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                borderWidth: 2,
                                tension: 0.1
                            },
                            {
                                label: 'MA (5)',
                                data: maShort,
                                borderColor: 'rgba(255, 159, 64, 1)',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                fill: false,
                                tension: 0.1
                            },
                            {
                                label: 'MA (20)',
                                data: maLong,
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 2,
                                borderDash: [10, 5],
                                fill: false,
                                tension: 0.1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: `${symbol} Fiyat Grafiği`,
                                font: {
                                    size: 16
                                }
                            },
                            legend: {
                                position: 'top',
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Tarih'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Fiyat (TL)'
                                }
                            }
                        }
                    }
                });
            }

            // Settings form
            document.getElementById('settingsForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const targetProfit = document.getElementById('targetProfitInput').value;
                const stopLoss = document.getElementById('stopLossInput').value;
                const maxHoldingWeeks = document.getElementById('maxHoldingWeeksInput').value;
                
                // In a real application, these would be saved to the server
                // For now, just show a success message
                showStatus('Ayarlar başarıyla kaydedildi.', 'success');
                addStatusMessage('Strateji parametreleri güncellendi.', 'success');
            });

            // Refresh symbols button
            document.getElementById('refreshSymbolsBtn').addEventListener('click', function() {
                this.disabled = true;
                this.innerHTML = '<span class="loading me-2"></span> Yenileniyor...';
                
                loadSymbols();
                
                setTimeout(() => {
                    this.disabled = false;
                    this.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Yenile';
                }, 1000);
            });

            // --- NEW REPORTING FUNCTIONS ---

            const reportDisplayArea = document.getElementById('reportDisplayArea');

            // Generate Daily Noon Report
            document.getElementById('generateDailyNoonReportBtn').addEventListener('click', function() {
                generateReport('/api/bist30/daily-report', { time_of_day: 'noon' }, 'Günlük Öğlen Raporu', this);
            });

            // Generate Daily Close Report
            document.getElementById('generateDailyCloseReportBtn').addEventListener('click', function() {
                generateReport('/api/bist30/daily-report', { time_of_day: 'close' }, 'Günlük Kapanış Raporu', this);
            });

            // Generate Weekly Report
            document.getElementById('generateWeeklyReportBtn').addEventListener('click', function() {
                generateReport('/api/bist30/weekly-report', {}, 'Haftalık Rapor', this);
            });

            // Generate Next Day Prediction
            document.getElementById('generateNextDayPredictionBtn').addEventListener('click', function() {
                generateReport('/api/bist30/next-day-prediction', {}, 'Ertesi Gün Tahmini', this);
            });

            // Generic report generation function
            function generateReport(apiUrl, payload, reportTitle, buttonElement) {
                buttonElement.disabled = true;
                buttonElement.innerHTML = '<span class="loading me-2"></span> Oluşturuluyor...';
                showStatus(`${reportTitle} oluşturuluyor...`, 'info');
                addStatusMessage(`${reportTitle} başlatıldı.`, 'info');

                fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showStatus(`${reportTitle} başarıyla oluşturuldu.`, 'success');
                        addStatusMessage(`${reportTitle} tamamlandı.`, 'success');
                        displayReport(data, reportTitle, apiUrl);
                    } else {
                        showStatus(`Hata: ${data.message}`, 'danger');
                        addStatusMessage(`${reportTitle} hatası: ${data.message}`, 'error');
                    }
                })
                .catch(error => {
                    console.error(`Error generating ${reportTitle}:`, error);
                    showStatus(`${reportTitle} oluşturulurken bir hata oluştu.`, 'danger');
                    addStatusMessage(`${reportTitle} oluşturulurken bir hata oluştu.`, 'error');
                })
                .finally(() => {
                    buttonElement.disabled = false;
                    // Restore original button text (remove loading spinner)
                    buttonElement.innerHTML = buttonElement.innerHTML.replace(/<span class="loading me-2"><\/span> Oluşturuluyor.../, buttonElement.textContent.trim());
                });
            }

            // Display report function
            function displayReport(data, reportTitle, reportType) {
                const reportCard = document.createElement('div');
                reportCard.className = 'col-md-6 mb-4';
                
                let cardBody = '';

                if (reportType === '/api/bist30/daily-report') {
                    const report = data.report;
                    cardBody = `
                        <p><strong>Tarih:</strong> ${report.date} (${report.time_of_day})</p>
                        <h5>Sinyaller</h5>
                        <p>Alım: ${report.buy_signals.length}, Satım: ${report.sell_signals.length}</p>
                        <h5>Performans Simülasyonu</h5>
                        <p>Toplam Kâr/Zarar: ${report.performance.total_profit_loss ? report.performance.total_profit_loss.toFixed(2) : '0.00'} TL</p>
                        <p>Ortalama Kâr/Zarar: %${report.performance.avg_profit_loss_percentage ? report.performance.avg_profit_loss_percentage.toFixed(2) : '0.00'}</p>
                        <p>Başarı Oranı: %${report.performance.success_rate ? report.performance.success_rate.toFixed(2) : '0.00'} (${report.performance.successful_trades}/${report.performance.total_trades})</p>
                        <h6>İşlem Detayları:</h6>
                        <ul>
                            ${report.trade_details.map(trade => `<li>${trade.symbol}: ${trade.scenario} (%${trade.profit_loss_percentage.toFixed(2)})</li>`).join('') || '<li>İşlem yok</li>'}
                        </ul>
                    `;
                } else if (reportType === '/api/bist30/weekly-report') {
                    const report = data.report;
                    cardBody = `
                        <p><strong>Hafta:</strong> ${report.week_start} - ${report.week_end}</p>
                        <h5>BIST30 Performansı</h5>
                        <p>Ortalama Değişim: %${report.bist30_performance.avg_change_percentage ? report.bist30_performance.avg_change_percentage.toFixed(2) : '0.00'}</p>
                        <p>Yükselen/Düşen: ${report.bist30_performance.positive_count}/${report.bist30_performance.negative_count}</p>
                        <h5>Bot Sinyal Performansı</h5>
                        <p>Ortalama Kâr/Zarar: %${report.signals_performance.performance.avg_profit_loss_percentage ? report.signals_performance.performance.avg_profit_loss_percentage.toFixed(2) : '0.00'}</p>
                        <p>Başarı Oranı: %${report.signals_performance.performance.success_rate ? report.signals_performance.performance.success_rate.toFixed(2) : '0.00'} (${report.signals_performance.performance.successful_trades}/${report.signals_performance.performance.total_trades})</p>
                        <p><strong>Bot vs BIST30:</strong> <span class="${report.comparison.bot_vs_market >= 0 ? 'text-success' : 'text-danger'}">%${report.comparison.bot_vs_market.toFixed(2)}</span></p>
                    `;
                } else if (reportType === '/api/bist30/next-day-prediction') {
                    const prediction = data.prediction;
                    cardBody = `
                        <p><strong>Tahmin Günü:</strong> ${prediction.next_trading_day}</p>
                        <h5>Alım Tavsiyeleri (${prediction.buy_recommendations.length})</h5>
                        <ul>
                            ${prediction.buy_recommendations.slice(0, 5).map(p => `<li>${p.symbol} (%${p.recommendation.confidence.toFixed(0)})</li>`).join('') || '<li>Yok</li>'}
                        </ul>
                        <h5>Satım Tavsiyeleri (${prediction.sell_recommendations.length})</h5>
                        <ul>
                            ${prediction.sell_recommendations.slice(0, 5).map(p => `<li>${p.symbol} (%${p.recommendation.confidence.toFixed(0)})</li>`).join('') || '<li>Yok</li>'}
                        </ul>
                        <h5>Bekle Tavsiyeleri (${prediction.hold_recommendations.length})</h5>
                        <ul>
                            ${prediction.hold_recommendations.slice(0, 5).map(p => `<li>${p.symbol}</li>`).join('') || '<li>Yok</li>'}
                        </ul>
                    `;
                }

                reportCard.innerHTML = `
                    <div class="card report-card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>${reportTitle}</span>
                            <button class="btn-close btn-sm" onclick="this.closest('.col-md-6').remove()"></button>
                        </div>
                        <div class="card-body">
                            ${cardBody}
                        </div>
                    </div>
                `;
                
                // Add to the beginning of the display area
                reportDisplayArea.prepend(reportCard);
            }

            // Telegram Test Button
            document.getElementById('testTelegramBtn').addEventListener('click', function() {
                this.disabled = true;
                this.innerHTML = '<span class="loading me-2"></span> Test Ediliyor...';
                
                showStatus('Telegram bağlantısı test ediliyor...', 'info');
                addStatusMessage('Telegram test mesajı gönderiliyor.', 'info');
                
                fetch('/api/bist30/test-telegram', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showStatus('✅ Telegram test başarılı! Mesaj gönderildi.', 'success');
                        addStatusMessage('Telegram bağlantısı başarıyla test edildi.', 'success');
                    } else {
                        showStatus(`❌ Telegram test başarısız: ${data.message}`, 'danger');
                        addStatusMessage(`Telegram test hatası: ${data.message}`, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error testing Telegram:', error);
                    showStatus('❌ Telegram test edilirken bir hata oluştu.', 'danger');
                    addStatusMessage('Telegram test edilirken bir hata oluştu.', 'error');
                })
                .finally(() => {
                    this.disabled = false;
                    this.innerHTML = '<i class="bi bi-telegram me-2"></i> Telegram Test Et';
                });
            });

            // Initialize
            loadSymbols();
        });
    </script>
</body>
</html>
